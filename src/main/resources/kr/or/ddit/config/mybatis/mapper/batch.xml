<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="batch">
	<select id="getCycleList" resultType="cycleVO">
		select * from cycle
	</select>
	
	<insert id="mergeDaily" parameterType="dailyVO">
		merge into daily
			using dual on (
				daily.pid = #{pid} and
				daily.cid = #{cid} and
				daily.dt = #{dt}
			)
			when matched then update set
				cnt = #{cnt}
			when not matched then insert
				(pid, cid, dt, cnt)
				values (#{pid}, #{cid}, #{dt}, #{cnt})
	</insert>
	
	<delete id="deleteDaily" parameterType="String">
		DELETE 
		FROM DAILY
		WHERE DT LIKE #{ym} || '%'
	</delete>

	<insert id="createDaily" parameterType="String">
		<![CDATA[
			INSERT INTO DAILY
			SELECT CYCLE.CID, CYCLE.PID, CAL.DT, CYCLE.CNT
			 FROM CYCLE,
			    (SELECT TO_CHAR(TO_DATE(#{ym}, 'YYYYMM') + (LEVEL-1) , 'YYYYMMDD') DT,
			            TO_CHAR(TO_DATE(#{ym}, 'YYYYMM') + (LEVEL-1) , 'D') DAY
			     FROM DUAL
			    CONNECT BY LEVEL <= LAST_DAY(TO_DATE(#{ym}, 'YYYYMM')) - TO_DATE(#{ym}, 'YYYYMM') +1) CAL
			WHERE CYCLE.DAY = CAL.DAY
			ORDER BY CID, PID, CAL.DT
		]]>
	</insert>

	<insert id="insertBatch" parameterType="batchVo">
		<selectKey keyColumn="bid" keyProperty="bid" resultType="int" order="BEFORE">
			SELECT SEQ_BATCH.NEXTVAL bid 
			 FROM DUAL
		</selectKey>
		INSERT INTO BATCH 
		VALUES 
		(
			 #{bid}
			,#{bcd}
			,#{st}
			,SYSDATE
			,NULL
		)
	</insert>

	<update id="updateBatch" parameterType="batchVo">
		UPDATE BATCH
		SET  ST 	= #{st}
			,ED_DT  = SYSDATE
		WHERE BID 	= #{bid}	
	</update>
	
</mapper>